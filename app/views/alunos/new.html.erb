<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">➕ Adicionar Aluno</h5>
        </div>
        <div class="card-body">
          <% if @aluno.errors.any? %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <h5><%= pluralize(@aluno.errors.count, "erro") %> impediu que este aluno fosse salvo:</h5>
              <ul class="mb-0">
                <% @aluno.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% end %>

          <form action="/alunos" method="POST">
            <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
            
            <div class="mb-3">
              <label class="form-label">E-mail</label>
              <input type="email" name="aluno[email]" class="form-control" value="<%= @aluno.email %>" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Nome Completo</label>
              <input type="text" name="aluno[nome]" class="form-control" value="<%= @aluno.nome %>" required>
            </div>

            <div class="mb-3">
              <label class="form-label">CPF</label>
              <input type="text" name="aluno[cpf]" id="cpf_input" class="form-control" placeholder="000.000.000-00" value="<%= @aluno.cpf %>" required maxlength="14">
              <small class="text-muted">Apenas números (11 dígitos)</small>
            </div>

            <div class="mb-3">
              <label class="form-label">Telefone</label>
              <input type="text" name="aluno[telefone]" class="form-control" placeholder="(11) 98765-4321" value="<%= @aluno.telefone %>">
            </div>

            <div class="mb-3">
              <label class="form-label">Data de Nascimento</label>
              <input type="date" name="aluno[data_nascimento]" class="form-control" value="<%= @aluno.data_nascimento&.strftime('%Y-%m-%d') %>">
            </div>

            <div class="mb-3">
              <label class="form-label">Plano</label>
              <select name="aluno[plano_id]" class="form-select" required>
                <option value="">Selecione um plano</option>
                <% Plano.all.each do |plano| %>
                  <option value="<%= plano.id %>" <%= 'selected' if @aluno.plano_id == plano.id %>><%= plano.nome_plano %></option>
                <% end %>
              </select>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">Salvar</button>
              <a href="/alunos" class="btn btn-secondary">Cancelar</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById('cpf_input').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.substring(0, 11);
    
    if (value.length > 9) {
      value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    } else if (value.length > 6) {
      value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
    } else if (value.length > 3) {
      value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
    }
    
    e.target.value = value;
  });

  document.querySelector('form').addEventListener('submit', function() {
    const cpfInput = document.getElementById('cpf_input');
    cpfInput.value = cpfInput.value.replace(/\D/g, '');
  });
</script>
